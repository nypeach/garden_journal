<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Plant: Garden Journal</title>
  <link rel="stylesheet" href="/static/base.css">
  <link rel="stylesheet" href="/static/forms.css">
</head>

<body>
  <main>
    <h1><span>‚ûï</span> Add Plant</h1>
    <p class="note">Add a new plant to your garden with location, container, and initial summary</p>

    <hr class="divider" />

    <form id="addPlantForm">

      <h2><span>üå±</span> Plant Information</h2>

      <div class="form-group">
        <label for="plant_type">
          Plant Type <span class="required">*</span>
        </label>
        <input type="text" id="plant_type" name="plant_type" placeholder="basil, tomato, strawberry, etc." required />
        <div class="help-text">Lowercase, used for plant ID generation (e.g., "basil" ‚Üí basil_001)</div>
      </div>

      <div class="form-group">
        <label for="common_name">
          Common Name <span class="required">*</span>
        </label>
        <input type="text" id="common_name" name="common_name" placeholder="Basil - Left, Cherry Tomato, etc."
          required />
        <div class="help-text">Display name for this plant</div>
      </div>

      <div class="form-group">
        <label for="variety">
          Variety (optional)
        </label>
        <input type="text" id="variety" name="variety" placeholder="Sweet Basil, Husky Cherry Red, etc." />
        <div class="help-text">Specific variety or cultivar</div>
      </div>

      <div class="form-group">
        <label for="purchase_date">
          Purchased/Sowed Date <span class="required">*</span>
        </label>
        <input type="date" id="purchase_date" name="purchase_date" required />
        <div class="help-text">When you acquired or planted this plant</div>
      </div>

      <div class="form-group">
        <label for="source">
          Source (optional)
        </label>
        <input type="text" id="source" name="source" placeholder="Lowe's, Garden Center, Seeds, etc." />
        <div class="help-text">Where you got this plant</div>
      </div>

      <hr class="divider" />

      <h2><span>üìç</span> Location & Container</h2>

      <div class="form-group">
        <label for="location">
          Current Location <span class="required">*</span>
        </label>
        <input type="text" id="location" name="location"
          placeholder="Panel 1, Panel 2, ..., Panel 18, Picnic Table, Indoors, etc." required />
        <div class="help-text">Where is this plant currently located?</div>
      </div>

      <div class="form-group">
        <label for="container_name">
          Container Name <span class="required">*</span>
        </label>
        <input type="text" id="container_name" name="container_name"
          placeholder="Basil Pot - Left, Pepper Box, Raised Bed, etc." required />
        <div class="help-text">Friendly name for the container (used for grouping)</div>
      </div>

      <div class="form-group">
        <label for="container_type">
          Container Type <span class="required">*</span>
        </label>
        <input type="text" id="container_type" name="container_type"
          placeholder="Round Pot, Window Planter, Raised Bed, etc." required />
        <div class="help-text">Type/description of container</div>
      </div>

      <div class="form-group">
        <label for="container_size">
          Container Size (optional)
        </label>
        <input type="text" id="container_size" name="container_size"
          placeholder="8 inch, 0.94 gal, 23.5 x 6 inches, etc." />
        <div class="help-text">Dimensions or volume of container</div>
      </div>

      <div class="form-group">
        <label for="stake_number">
          Stake Number (optional)
        </label>
        <input type="number" id="stake_number" name="stake_number" placeholder="1, 2, 3, 4..." min="1" />
        <div class="help-text">If plant is in a shared staked container (like Pepper Box or Raised Bed)</div>
      </div>

      <div class="form-group">
        <label for="position">
          Position (optional)
        </label>
        <input type="text" id="position" name="position" placeholder="left section, edges, center, etc." />
        <div class="help-text">Position in shared container (like Garlic Box)</div>
      </div>

      <hr class="divider" />

      <h2><span>üåæ</span> Soil & Care</h2>

      <div class="form-group">
        <label for="soil_mix">
          Soil Mix <span class="required">*</span>
        </label>
        <input type="text" id="soil_mix" name="soil_mix"
          placeholder="Potting Mix, Topsoil/Sand, 1:3 Pebbles:Potting Mix, etc." required />
        <div class="help-text">Type of soil in this container</div>
      </div>

      <div class="form-group">
        <label for="summary">
          Initial Plant Summary (optional)
        </label>
        <textarea id="summary" name="summary" placeholder="Initial assessment, care notes, temperature thresholds, etc."
          rows="4"></textarea>
        <div class="help-text">Your initial notes about this plant (can be updated later in daily entries)</div>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">
          ‚ûï Add Plant
        </button>
        <a href="/" class="btn btn-secondary">Cancel</a>
      </div>

    </form>

    {% if error %}
    <div class="error-message">
      <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

  </main>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-icon">‚úÖ</span>
        <h2 class="modal-title">Plant Added Successfully!</h2>
      </div>
      <div class="modal-body">
        <p><strong>Plant:</strong> <span id="modal-plant-name"></span></p>
        <p><strong>Plant ID:</strong> <span id="modal-plant-id"></span></p>
        <p><strong>Location:</strong> <span id="modal-location"></span></p>
        <p><strong>Container:</strong> <span id="modal-container"></span></p>
      </div>
      <div class="modal-buttons">
        <a href="/output/Garden_02_Plant_by_Plant_Summary.html" target="_blank" class="btn btn-primary">
          View Plant Summary
        </a>
        <button onclick="addAnother()" class="btn btn-secondary">Add Another Plant</button>
        <button onclick="closeModal()" class="btn btn-secondary">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Set today's date as default (using user's local timezone)
    const today = new Date();
    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
    document.getElementById('purchase_date').valueAsDate = new Date();

    // Handle form submission
    document.getElementById('addPlantForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const stake_number = document.getElementById('stake_number').value;
      const position = document.getElementById('position').value;
      const variety = document.getElementById('variety').value;
      const source = document.getElementById('source').value;
      const container_size = document.getElementById('container_size').value;
      const summary = document.getElementById('summary').value;

      const formData = {
        plant_type: document.getElementById('plant_type').value.toLowerCase().replace(/\s+/g, '_'),
        common_name: document.getElementById('common_name').value,
        variety: variety || null,
        purchase_date: document.getElementById('purchase_date').value.replace(/-/g, ''),
        source: source || null,
        location: document.getElementById('location').value,
        container_type: document.getElementById('container_type').value,
        container_name: document.getElementById('container_name').value,
        container_size: container_size || null,
        soil_mix: document.getElementById('soil_mix').value,
        stake_number: stake_number ? parseInt(stake_number) : null,
        position: position || null,
        summary: summary || null
      };

      try {
        const response = await fetch('/api/add-plant', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
          // Show success modal
          document.getElementById('modal-plant-name').textContent = result.plant.common_name;
          document.getElementById('modal-plant-id').textContent = result.plant.plant_id;
          document.getElementById('modal-location').textContent = result.plant.current_location.location;
          document.getElementById('modal-container').textContent = result.plant.current_location.container_name;
          document.getElementById('successModal').classList.add('active');
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error submitting form: ' + error.message);
      }
    });

    function closeModal() {
      document.getElementById('successModal').classList.remove('active');
      window.location.href = '/';
    }

    function addAnother() {
      document.getElementById('successModal').classList.remove('active');
      // Reset form
      document.getElementById('addPlantForm').reset();
      const today = new Date();
      today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
      document.getElementById('purchase_date').valueAsDate = today;
    }
  </script>
</body>

</html>