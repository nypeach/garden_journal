<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Entry: Garden Journal</title>
  <link rel="stylesheet" href="/static/base.css">
  <link rel="stylesheet" href="/static/forms.css">
  <style>
    /* Fix input overflow issues */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      box-sizing: border-box;
      max-width: 100%;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .form-group {
      flex: 1;
      min-width: 0;
    }

    /* Section headers */
    .section-header {
      margin-top: 20px;
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 600;
      color: var(--green);
      background: #f0f9f4;
      padding: 10px 14px;
      border-radius: 6px;
      border-left: 3px solid var(--green);
    }

    /* Photo preview styles */
    .photo-preview-grid {
      display: grid;
      gap: 16px;
      margin-top: 16px;
    }

    .photo-preview-item {
      border: 1px solid var(--rule);
      border-radius: 8px;
      padding: 16px;
      background: #fafafa;
    }

    .photo-preview-layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .photo-preview-thumb {
      width: 150px;
      height: 112px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--rule);
      flex-shrink: 0;
    }

    .photo-preview-fields {
      flex: 1;
      min-width: 0;
    }

    .photo-size-info {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <main>
    <h1><span>üìî</span> Daily Entry</h1>
    <p class="note">Record daily observations, weather, activities, and plant-by-plant notes</p>

    <hr class="divider" />

    <form id="dailyEntryForm">

      <!-- BASIC INFORMATION -->
      <h2><span>üìÖ</span> Basic Information</h2>

      <div class="form-group">
        <label for="entry_date">
          Date <span class="required">*</span>
        </label>
        <input type="date" id="entry_date" name="entry_date" required />
        <div class="help-text">Date of this journal entry</div>
      </div>

      <div class="form-group">
        <label for="entry_time">
          Time of Entry <span class="required">*</span>
        </label>
        <input type="time" id="entry_time" name="entry_time" required />
        <div class="help-text">When you're filling out this form</div>
      </div>

      <hr class="divider" />

      <!-- SECTION 1: SUMMARY OF ACTIVITIES -->
      <h2><span>üìù</span> Summary of Activities</h2>

      <div class="form-group">
        <label for="activities">
          What did you do today?
        </label>
        <textarea id="activities" name="activities" placeholder="Use markdown bullets:
- Watered all plants
- Pruned tomato
   - Removed diseased leaves
   - Cut back lower branches
- Added mulch to raised bed" rows="8"></textarea>
        <div class="help-text">Use <code>- </code> for bullets, <code>   - </code> (3 spaces + dash) for indented
          bullets</div>
      </div>

      <hr class="divider" />

      <!-- SECTION 2: WEATHER / SUN CONDITIONS -->
      <h2><span>‚òÄÔ∏è</span> Weather / Sun Conditions</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="temp_high">Temperature High (¬∞F)</label>
          <input type="number" id="temp_high" name="temp_high" placeholder="78" />
        </div>

        <div class="form-group">
          <label for="temp_low">Temperature Low (¬∞F)</label>
          <input type="number" id="temp_low" name="temp_low" placeholder="68" />
        </div>
      </div>

      <div class="form-group">
        <label for="conditions">Current Conditions</label>
        <input type="text" id="conditions" name="conditions" placeholder="Sunny, Partly cloudy, Overcast, etc." />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="sunrise">Sunrise Time</label>
          <input type="time" id="sunrise" name="sunrise" />
        </div>

        <div class="form-group">
          <label for="sunset">Sunset Time</label>
          <input type="time" id="sunset" name="sunset" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="humidity">Humidity</label>
          <input type="text" id="humidity" name="humidity" placeholder="65%, High, Low, etc." />
        </div>

        <div class="form-group">
          <label for="wind">Wind</label>
          <input type="text" id="wind" name="wind" placeholder="Light breeze, Calm, 10-15 mph, etc." />
        </div>
      </div>

      <div class="form-group">
        <label for="weather_notes">Weather Notes</label>
        <textarea id="weather_notes" name="weather_notes" placeholder="Additional weather observations..."
          rows="3"></textarea>
      </div>

      <hr class="divider" />

      <!-- SECTION 3: GENERAL OBSERVATIONS -->
      <h2><span>üìù</span> General Observations</h2>

      <div class="form-group">
        <label for="observations">
          Garden-wide observations
        </label>
        <textarea id="observations" name="observations" placeholder="Use markdown bullets:
- All plants looking healthy after rain
- Noticed more bees today
- Some fungal issues on lower leaves" rows="6"></textarea>
        <div class="help-text">Observations about the whole garden (not specific to one plant)</div>
      </div>

      <hr class="divider" />

      <!-- SECTION 4: QUESTIONS & ANSWERS (GENERAL) -->
      <h2><span>‚ùì</span> Questions & Answers</h2>
      <p class="note">General garden questions and research (not plant-specific)</p>

      <div id="qaContainer">
        <!-- Q&A pairs will be added here -->
      </div>

      <button type="button" onclick="addQA()" class="btn btn-secondary" style="margin-top: 12px;">
        + Add Question & Answer
      </button>

      <hr class="divider" />

      <!-- SECTION 5: UPCOMING ACTIONS -->
      <h2><span>üìã</span> Upcoming Actions</h2>
      <p class="note">Planned future tasks</p>

      <div id="actionsContainer">
        <!-- Actions will be added here -->
      </div>

      <button type="button" onclick="addAction()" class="btn btn-secondary" style="margin-top: 12px;">
        + Add Upcoming Action
      </button>

      <hr class="divider" />

      <!-- SECTION 6: PLANT BY PLANT -->
      <h2 class="major-section"><span>ü™¥</span> Plant by Plant</h2>
      <p class="note">Individual plant observations with photos</p>

      <div id="plantObservationsContainer">
        <!-- Plant observations will be added here -->
      </div>

      <button type="button" onclick="addPlantObservation()" class="btn btn-secondary" style="margin-top: 12px;">
        + Add Plant Observation
      </button>

      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">
          üíæ Save Entry & Generate Journal
        </button>
        <a href="/" class="btn btn-secondary">Cancel</a>
      </div>

    </form>

  </main>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-icon">‚úÖ</span>
        <h2 class="modal-title">Daily Entry Saved!</h2>
      </div>
      <div class="modal-body">
        <p><strong>Date:</strong> <span id="modal-date"></span></p>
        <p id="modal-summary"></p>
      </div>
      <div class="modal-buttons">
        <a href="#" id="viewJournalLink" target="_blank" class="btn btn-primary">
          View Journal
        </a>
        <button onclick="addAnother()" class="btn btn-secondary">Add Another Entry</button>
        <button onclick="closeModal()" class="btn btn-secondary">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize
    let activeP plants = [];
    let qaCount = 0;
    let actionCount = 0;
    let plantObsCount = 0;
    const plantQACounts = {};
    const plantPhotos = {}; // Store photos by plant observation ID

    // Load active plants on page load
    fetch('/api/plants')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          activePlants = data.plants;
        }
      })
      .catch(err => console.error('Error loading plants:', err));

    // Set defaults
    document.getElementById('entry_date').valueAsDate = new Date();
    const localNow = new Date();
    const hours = localNow.getHours().toString().padStart(2, '0');
    const minutes = localNow.getMinutes().toString().padStart(2, '0');
    document.getElementById('entry_time').value = `${hours}:${minutes}`;

    // ========================================
    // Q&A MANAGEMENT
    // ========================================

    function addQA() {
      qaCount++;
      const container = document.getElementById('qaContainer');
      const qaDiv = document.createElement('div');
      qaDiv.className = 'form-group';
      qaDiv.id = `qa-${qaCount}`;
      qaDiv.innerHTML = `
        <div style="border: 1px solid var(--rule); border-radius: 6px; padding: 16px; margin: 12px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong>Q&A #${qaCount}</strong>
            <button type="button" onclick="removeQA(${qaCount})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">Remove</button>
          </div>
          <div class="form-group">
            <label for="question_${qaCount}">Question</label>
            <input type="text" id="question_${qaCount}" name="question_${qaCount}" placeholder="What causes blossom end rot?" />
          </div>
          <div class="form-group">
            <label for="answer_${qaCount}">Answer</label>
            <textarea id="answer_${qaCount}" name="answer_${qaCount}" placeholder="Calcium deficiency, often from inconsistent watering..." rows="3"></textarea>
          </div>
        </div>
      `;
      container.appendChild(qaDiv);
    }

    function removeQA(id) {
      document.getElementById(`qa-${id}`).remove();
    }

    // ========================================
    // ACTIONS MANAGEMENT
    // ========================================

    function addAction() {
      actionCount++;
      const container = document.getElementById('actionsContainer');
      const actionDiv = document.createElement('div');
      actionDiv.className = 'form-group';
      actionDiv.id = `action-${actionCount}`;
      actionDiv.innerHTML = `
        <div style="border: 1px solid var(--rule); border-radius: 6px; padding: 16px; margin: 12px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <strong>Action #${actionCount}</strong>
            <button type="button" onclick="removeAction(${actionCount})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">Remove</button>
          </div>
          <div class="form-group">
            <label for="action_desc_${actionCount}">Description</label>
            <input type="text" id="action_desc_${actionCount}" name="action_desc_${actionCount}" placeholder="Fertilize tomatoes, reseed arugula, etc." />
          </div>
          <div class="form-group">
            <label for="action_date_${actionCount}">Target Date (optional)</label>
            <input type="date" id="action_date_${actionCount}" name="action_date_${actionCount}" />
          </div>
          <div class="form-group">
            <label for="action_timeframe_${actionCount}">Target Timeframe (optional)</label>
            <input type="text" id="action_timeframe_${actionCount}" name="action_timeframe_${actionCount}" placeholder="in 3 days, next week, etc." />
          </div>
        </div>
      `;
      container.appendChild(actionDiv);
    }

    function removeAction(id) {
      document.getElementById(`action-${id}`).remove();
    }

    // ========================================
    // PLANT OBSERVATION MANAGEMENT
    // ========================================

    function addPlantObservation() {
      plantObsCount++;
      plantQACounts[plantObsCount] = 0;
      plantPhotos[plantObsCount] = [];

      const plantOptions = activePlants.map(p =>
        `<option value="${p.plant_id}">${p.common_name} (${p.plant_id})</option>`
      ).join('');

      const container = document.getElementById('plantObservationsContainer');
      const obsDiv = document.createElement('div');
      obsDiv.className = 'plant-observation';
      obsDiv.id = `plant_obs_${plantObsCount}`;
      obsDiv.innerHTML = `
        <div style="border: 2px solid var(--green); border-radius: 8px; padding: 20px; margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; color: var(--green);">Plant Observation #${plantObsCount}</h3>
            <button type="button" onclick="removePlantObservation(${plantObsCount})" class="btn btn-secondary" style="padding: 8px 14px;">Remove</button>
          </div>

          <!-- Plant Selection & Time -->
          <div class="form-row">
            <div class="form-group">
              <label for="plant_select_${plantObsCount}">Select Plant *</label>
              <select id="plant_select_${plantObsCount}" name="plant_select_${plantObsCount}" required onchange="loadPlantData(${plantObsCount})">
                <option value="">-- Select a plant --</option>
                ${plantOptions}
              </select>
            </div>

            <div class="form-group">
              <label for="plant_time_${plantObsCount}">Time of Observation *</label>
              <input type="time" id="plant_time_${plantObsCount}" name="plant_time_${plantObsCount}" required />
            </div>
          </div>

          <!-- Plant Summary -->
          <div class="form-group">
            <label for="plant_summary_${plantObsCount}">Plant Summary (editable)</label>
            <textarea id="plant_summary_${plantObsCount}" name="plant_summary_${plantObsCount}" placeholder="Current plant summary will load here..." rows="3"></textarea>
            <div class="help-text">Edit to update, keep as-is, or append new observations</div>
          </div>

          <!-- Plant Status -->
          <div class="form-row">
            <div class="form-group">
              <label for="plant_status_${plantObsCount}">Plant Status</label>
              <select id="plant_status_${plantObsCount}" name="plant_status_${plantObsCount}" onchange="toggleStatusReason(${plantObsCount})" data-original-status="active">
                <option value="active">Active</option>
                <option value="died">Died</option>
                <option value="harvested">Harvested</option>
                <option value="removed">Removed</option>
              </select>
            </div>
          </div>

          <!-- Status Change Reason (initially hidden) -->
          <div class="form-group" id="status_reason_group_${plantObsCount}" style="display: none;">
            <label for="status_reason_${plantObsCount}">Reason for Status Change *</label>
            <input type="text" id="status_reason_${plantObsCount}" name="status_reason_${plantObsCount}" placeholder="Water rot, harvested and composted, etc." />
            <div class="help-text">Why is this plant's status changing?</div>
          </div>

          <!-- Container Info -->
          <h3 class="section-header">Container & Location</h3>

          <div class="form-row" style="margin-top: 12px;">
            <div class="form-group">
              <label for="container_name_${plantObsCount}">Container Name</label>
              <input type="text" id="container_name_${plantObsCount}" name="container_name_${plantObsCount}" placeholder="Auto-filled from plant data" />
            </div>

            <div class="form-group">
              <label for="container_type_${plantObsCount}">Container Type</label>
              <input type="text" id="container_type_${plantObsCount}" name="container_type_${plantObsCount}" placeholder="Auto-filled from plant data" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="container_size_${plantObsCount}">Container Size (optional)</label>
              <input type="text" id="container_size_${plantObsCount}" name="container_size_${plantObsCount}" placeholder="8 inch, 0.94 gal, etc." />
            </div>

            <div class="form-group">
              <label for="stake_${plantObsCount}">Stake Number (optional)</label>
              <input type="number" id="stake_${plantObsCount}" name="stake_${plantObsCount}" placeholder="1, 2, 3, 4" />
            </div>

            <div class="form-group">
              <label for="position_${plantObsCount}">Position (optional)</label>
              <input type="text" id="position_${plantObsCount}" name="position_${plantObsCount}" placeholder="left section, edges, etc." />
            </div>
          </div>

          <!-- Soil Conditions -->
          <h3 class="section-header">Soil Conditions</h3>

          <div class="form-row" style="margin-top: 12px;">
            <div class="form-group">
              <label for="soil_moisture_${plantObsCount}">Soil Moisture</label>
              <input type="text" id="soil_moisture_${plantObsCount}" name="soil_moisture_${plantObsCount}" placeholder="bone dry, lightly moist, 4 (ideal)" />
            </div>

            <div class="form-group">
              <label for="soil_ph_${plantObsCount}">Soil pH</label>
              <input type="text" id="soil_ph_${plantObsCount}" name="soil_ph_${plantObsCount}" placeholder="6.5, between 6-7, slightly acidic" />
            </div>

            <div class="form-group">
              <label for="soil_fertility_${plantObsCount}">Soil Fertility</label>
              <input type="text" id="soil_fertility_${plantObsCount}" name="soil_fertility_${plantObsCount}" placeholder="Yellow (Low), Green (High)" />
            </div>
          </div>

          <!-- Growth Stages -->
          <h3 class="section-header">Growth</h3>

          <div class="form-row" style="margin-top: 12px;">
            <div class="form-group">
              <label for="current_stage_${plantObsCount}">Current Stage</label>
              <input type="text" id="current_stage_${plantObsCount}" name="current_stage_${plantObsCount}" placeholder="Seedling, Vegetative, Flowering, Fruiting" />
            </div>

            <div class="form-group">
              <label for="next_stage_${plantObsCount}">Next Stage</label>
              <input type="text" id="next_stage_${plantObsCount}" name="next_stage_${plantObsCount}" placeholder="Flowering, Fruiting, Harvest" />
            </div>
          </div>

          <!-- Observations, Actions, Notes -->
          <div class="form-group">
            <label for="plant_observations_${plantObsCount}">Observations</label>
            <textarea id="plant_observations_${plantObsCount}" name="plant_observations_${plantObsCount}" placeholder="What did you observe about this plant?" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label for="plant_actions_${plantObsCount}">Actions Taken (markdown bullets)</label>
            <textarea id="plant_actions_${plantObsCount}" name="plant_actions_${plantObsCount}"
              placeholder="- Watered 1¬Ω cups&#10;- Pruned lower leaves&#10;   - Removed diseased branches" rows="4"></textarea>
            <div class="help-text">Use <code>- </code> for bullets, <code>   - </code> for indented</div>
          </div>

          <div class="form-group">
            <label for="plant_notes_${plantObsCount}">Notes</label>
            <textarea id="plant_notes_${plantObsCount}" name="plant_notes_${plantObsCount}" placeholder="Additional notes..." rows="2"></textarea>
          </div>

          <!-- PHASE 3: PHOTOS -->
          <h3 class="section-header">üì∑ Photos</h3>

          <div class="form-group" style="margin-top: 12px;">
            <label for="photo_input_${plantObsCount}">
              Select Photos from Google Drive
            </label>
            <input
              type="file"
              id="photo_input_${plantObsCount}"
              name="photo_input_${plantObsCount}"
              accept="image/jpeg,image/jpg"
              multiple
              onchange="handlePhotoSelection(${plantObsCount}, this.files)"
            />
            <div class="help-text">
              Browse to: ~/Library/CloudStorage/GoogleDrive.../My Drive/GardenPhotos/
            </div>
          </div>

          <!-- Photo Preview Container -->
          <div id="photo_preview_${plantObsCount}" class="photo-preview-grid">
            <p style="color: var(--muted); font-style: italic; font-size: 14px;">No photos selected</p>
          </div>

          <!-- Plant Q&A -->
          <h3 class="section-header">‚ùì Plant-Specific Q&A</h3>

          <div id="plant_qa_container_${plantObsCount}" style="margin-top: 12px;">
            <!-- Plant Q&A pairs will be added here -->
          </div>

          <button type="button" onclick="addPlantQA(${plantObsCount})" class="btn btn-secondary" style="margin-top: 12px;">
            + Add Plant Q&A
          </button>

        </div>
      `;

      container.appendChild(obsDiv);

      // Set default time to current time
      document.getElementById(`plant_time_${plantObsCount}`).value = `${hours}:${minutes}`;
    }

    function removePlantObservation(id) {
      document.getElementById(`plant_obs_${id}`).remove();
      delete plantPhotos[id];
    }

    async function loadPlantData(plantObsId) {
      const plantSelect = document.getElementById(`plant_select_${plantObsId}`);
      const plant_id = plantSelect.value;

      if (!plant_id) return;

      try {
        const response = await fetch(`/api/plant/${plant_id}`);
        const result = await response.json();

        if (result.success && result.plant) {
          const plant = result.plant;

          // Load summary
          document.getElementById(`plant_summary_${plantObsId}`).value = plant.summary || '';

          // Set status and store original
          const statusSelect = document.getElementById(`plant_status_${plantObsId}`);
          statusSelect.value = plant.status || 'active';
          statusSelect.dataset.originalStatus = plant.status || 'active';

          // Load container info
          const loc = plant.current_location || {};
          document.getElementById(`container_name_${plantObsId}`).value = loc.container_name || '';
          document.getElementById(`container_type_${plantObsId}`).value = loc.container_type || '';
          document.getElementById(`stake_${plantObsId}`).value = loc.stake || '';
          document.getElementById(`position_${plantObsId}`).value = loc.position || '';
        }
      } catch (error) {
        console.error('Error loading plant data:', error);
      }
    }

    function toggleStatusReason(plantObsId) {
      const statusSelect = document.getElementById(`plant_status_${plantObsId}`);
      const originalStatus = statusSelect.dataset.originalStatus || 'active';
      const newStatus = statusSelect.value;
      const reasonGroup = document.getElementById(`status_reason_group_${plantObsId}`);

      // Show reason field only if changing FROM active TO something else
      if (originalStatus === 'active' && newStatus !== 'active') {
        reasonGroup.style.display = 'block';
        document.getElementById(`status_reason_${plantObsId}`).required = true;
      } else {
        reasonGroup.style.display = 'none';
        document.getElementById(`status_reason_${plantObsId}`).required = false;
      }
    }

    function addPlantQA(plantObsId) {
      if (!plantQACounts[plantObsId]) plantQACounts[plantObsId] = 0;
      plantQACounts[plantObsId]++;

      const qaId = plantQACounts[plantObsId];
      const container = document.getElementById(`plant_qa_container_${plantObsId}`);

      const qaDiv = document.createElement('div');
      qaDiv.id = `plant_qa_${plantObsId}_${qaId}`;
      qaDiv.innerHTML = `
        <div style="border: 1px solid var(--rule); border-radius: 6px; padding: 12px; margin: 8px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong style="font-size: 14px;">Q&A #${qaId}</strong>
            <button type="button" onclick="removePlantQA(${plantObsId}, ${qaId})" class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;">Remove</button>
          </div>
          <div class="form-group">
            <label for="plant_question_${plantObsId}_${qaId}">Question</label>
            <input type="text" id="plant_question_${plantObsId}_${qaId}" name="plant_question_${plantObsId}_${qaId}" placeholder="Why are leaves yellowing?" />
          </div>
          <div class="form-group">
            <label for="plant_answer_${plantObsId}_${qaId}">Answer</label>
            <textarea id="plant_answer_${plantObsId}_${qaId}" name="plant_answer_${plantObsId}_${qaId}" placeholder="Possible nitrogen deficiency..." rows="2"></textarea>
          </div>
        </div>
      `;
      container.appendChild(qaDiv);
    }

    function removePlantQA(plantObsId, qaId) {
      document.getElementById(`plant_qa_${plantObsId}_${qaId}`).remove();
    }

    // ========================================
    // PHASE 3: PHOTO HANDLING
    // ========================================

    async function handlePhotoSelection(plantObsId, files) {
      if (!files || files.length === 0) return;

      const plant_id = document.getElementById(`plant_select_${plantObsId}`).value;
      if (!plant_id) {
        alert('Please select a plant first before adding photos');
        document.getElementById(`photo_input_${plantObsId}`).value = '';
        return;
      }

      // Process each selected file
      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Validate file type
        if (!file.type.match('image/jpeg')) {
          alert(`Skipping ${file.name} - only JPEG files are supported`);
          continue;
        }

        // Check file size (warn if > 10MB)
        if (file.size > 10 * 1024 * 1024) {
          if (!confirm(`${file.name} is ${(file.size / 1024 / 1024).toFixed(1)}MB. Continue?`)) {
            continue;
          }
        }

        try {
          const photoData = await processPhoto(file, plant_id, plantObsId);
          plantPhotos[plantObsId].push(photoData);
        } catch (error) {
          console.error(`Error processing ${file.name}:`, error);
          alert(`Error processing ${file.name}: ${error.message}`);
        }
      }

      // Display photo previews
      displayPhotoPreview(plantObsId);

      // Clear file input
      document.getElementById(`photo_input_${plantObsId}`).value = '';
    }

    async function processPhoto(file, plant_id, plantObsId) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const img = new Image();
            img.onload = async () => {
              // Extract EXIF data (simple version using file date)
              const exifData = extractEXIF(file);

              // Generate suggested filename
              const suggestedFilename = generatePhotoFilename(plant_id, exifData, plantObsId);

              // Compress image
              const compressedBlob = await compressImage(img, 600, 450, 0.9);

              // Create photo data object
              const photoData = {
                originalFile: file,
                compressedBlob: compressedBlob,
                suggestedFilename: suggestedFilename,
                caption: '',
                tags: '',
                preview: e.target.result,
                exif: exifData
              };

              resolve(photoData);
            };

            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = e.target.result;
          } catch (error) {
            reject(error);
          }
        };

        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function extractEXIF(file) {
      // Simple EXIF extraction using file modification time
      // For production, consider using exif-js library for real EXIF data
      const modDate = new Date(file.lastModified);

      return {
        date: modDate.toISOString().split('T')[0].replace(/-/g, ''), // YYYYMMDD
        time: modDate.getHours().toString().padStart(2, '0') + modDate.getMinutes().toString().padStart(2, '0') // HHMM
      };
    }

    function generatePhotoFilename(plant_id, exifData, plantObsId) {
      // Get current sequence number for this plant_id + date + time combo
      const existingPhotos = plantPhotos[plantObsId] || [];
      const sameDateTime = existingPhotos.filter(p =>
        p.suggestedFilename &&
        p.suggestedFilename.includes(`${plant_id}_${exifData.date}_${exifData.time}`)
      );

      const seq = sameDateTime.length + 1;

      return `${plant_id}_${exifData.date}_${exifData.time}_${seq}.jpg`;
    }

    async function compressImage(img, maxWidth, maxHeight, quality) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Calculate dimensions maintaining aspect ratio
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = Math.round((width * maxHeight) / height);
            height = maxHeight;
          }
        }

        canvas.width = width;
        canvas.height = height;

        // Draw and compress
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob((blob) => {
          resolve(blob);
        }, 'image/jpeg', quality);
      });
    }

    function displayPhotoPreview(plantObsId) {
      const container = document.getElementById(`photo_preview_${plantObsId}`);
      const photos = plantPhotos[plantObsId] || [];

      if (photos.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); font-style: italic; font-size: 14px;">No photos selected</p>';
        return;
      }

      container.innerHTML = '';

      photos.forEach((photo, index) => {
        const photoDiv = document.createElement('div');
        photoDiv.className = 'photo-preview-item';
        photoDiv.innerHTML = `
          <div class="photo-preview-layout">
            <img src="${photo.preview}" class="photo-preview-thumb" alt="Preview" />
            <div class="photo-preview-fields">
              <div class="form-group" style="margin: 0 0 10px 0;">
                <label style="font-size: 13px; font-weight: 600;">Filename:</label>
                <input
                  type="text"
                  value="${photo.suggestedFilename}"
                  onchange="updatePhotoFilename(${plantObsId}, ${index}, this.value)"
                  style="font-family: monospace; font-size: 12px; padding: 6px 8px; width: 100%;"
                />
              </div>
              <div class="form-group" style="margin: 0 0 10px 0;">
                <label style="font-size: 13px;">Caption:</label>
                <input
                  type="text"
                  placeholder="Before pruning, closeup of leaves, etc."
                  onchange="updatePhotoCaption(${plantObsId}, ${index}, this.value)"
                  value="${photo.caption}"
                  style="padding: 6px 8px; width: 100%;"
                />
              </div>
              <div class="form-group" style="margin: 0;">
                <label style="font-size: 13px;">Tags:</label>
                <input
                  type="text"
                  placeholder="before_pruning, closeup, diseased_leaves"
                  onchange="updatePhotoTags(${plantObsId}, ${index}, this.value)"
                  value="${photo.tags}"
                  style="padding: 6px 8px; width: 100%;"
                />
              </div>
            </div>
            <button type="button" onclick="removePhoto(${plantObsId}, ${index})" class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px; align-self: flex-start;">
              Remove
            </button>
          </div>
          <div class="photo-size-info">
            Original: ${photo.originalFile.name} (${(photo.originalFile.size / 1024).toFixed(0)} KB) ‚Üí
            Compressed: ~${(photo.compressedBlob.size / 1024).toFixed(0)} KB
          </div>
        `;
        container.appendChild(photoDiv);
      });
    }

    function updatePhotoFilename(plantObsId, photoIndex, newFilename) {
      if (plantPhotos[plantObsId] && plantPhotos[plantObsId][photoIndex]) {
        plantPhotos[plantObsId][photoIndex].suggestedFilename = newFilename;
      }
    }

    function updatePhotoCaption(plantObsId, photoIndex, caption) {
      if (plantPhotos[plantObsId] && plantPhotos[plantObsId][photoIndex]) {
        plantPhotos[plantObsId][photoIndex].caption = caption;
      }
    }

    function updatePhotoTags(plantObsId, photoIndex, tags) {
      if (plantPhotos[plantObsId] && plantPhotos[plantObsId][photoIndex]) {
        plantPhotos[plantObsId][photoIndex].tags = tags;
      }
    }

    function removePhoto(plantObsId, photoIndex) {
      if (plantPhotos[plantObsId]) {
        plantPhotos[plantObsId].splice(photoIndex, 1);
        displayPhotoPreview(plantObsId);
      }
    }

    // ========================================
    // FORM SUBMISSION
    // ========================================

    document.getElementById('dailyEntryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        date: document.getElementById('entry_date').value.replace(/-/g, ''),
        time_of_entry: document.getElementById('entry_time').value.replace(/:/g, ''),
        activities: document.getElementById('activities').value,
        weather: {
          temp_high: document.getElementById('temp_high').value || null,
          temp_low: document.getElementById('temp_low').value || null,
          conditions: document.getElementById('conditions').value || null,
          sunrise: document.getElementById('sunrise').value ?
            document.getElementById('sunrise').value.replace(/:/g, '') : null,
          sunset: document.getElementById('sunset').value ?
            document.getElementById('sunset').value.replace(/:/g, '') : null,
          humidity: document.getElementById('humidity').value || null,
          wind: document.getElementById('wind').value || null,
          notes: document.getElementById('weather_notes').value || null
        },
        observations: document.getElementById('observations').value,
        qa: collectQA(),
        upcoming_actions: collectActions(),
        plant_observations: await collectPlantObservations()
      };

      console.log('Form data (Phase 3 with photos):', formData);
      alert('Phase 3 form data logged to console! Check browser DevTools ‚Üí Console to see complete data including photos.');
    });

    function collectQA() {
      const qaPairs = [];
      for (let i = 1; i <= qaCount; i++) {
        const questionEl = document.getElementById(`question_${i}`);
        const answerEl = document.getElementById(`answer_${i}`);
        if (questionEl && answerEl && questionEl.value) {
          qaPairs.push({
            question: questionEl.value,
            answer: answerEl.value
          });
        }
      }
      return qaPairs;
    }

    function collectActions() {
      const actions = [];
      for (let i = 1; i <= actionCount; i++) {
        const descEl = document.getElementById(`action_desc_${i}`);
        const dateEl = document.getElementById(`action_date_${i}`);
        const timeframeEl = document.getElementById(`action_timeframe_${i}`);
        if (descEl && descEl.value) {
          actions.push({
            description: descEl.value,
            target_date: dateEl.value ? dateEl.value.replace(/-/g, '') : null,
            target_timeframe: timeframeEl.value || null
          });
        }
      }
      return actions;
    }

    async function collectPlantObservations() {
      const observations = [];

      for (let i = 1; i <= plantObsCount; i++) {
        const plantSelectEl = document.getElementById(`plant_select_${i}`);
        if (!plantSelectEl || !plantSelectEl.value) continue;

        const statusSelect = document.getElementById(`plant_status_${i}`);
        const originalStatus = statusSelect.dataset.originalStatus || 'active';
        const newStatus = statusSelect.value;

        // Collect photos for this observation
        const photos = (plantPhotos[i] || []).map(photo => ({
          filename: photo.suggestedFilename,
          caption: photo.caption || null,
          tags: photo.tags ? photo.tags.split(',').map(t => t.trim()) : [],
          timestamp: photo.exif.time,
          compressed_blob: photo.compressedBlob,
          compressed_size: photo.compressedBlob.size
        }));

        const obs = {
          plant_id: plantSelectEl.value,
          time: document.getElementById(`plant_time_${i}`).value.replace(/:/g, ''),
          summary: document.getElementById(`plant_summary_${i}`).value,
          status: newStatus,
          status_changed: originalStatus !== newStatus,
          status_reason: (originalStatus === 'active' && newStatus !== 'active') ?
            document.getElementById(`status_reason_${i}`).value : null,
          container: {
            name: document.getElementById(`container_name_${i}`).value || null,
            type: document.getElementById(`container_type_${i}`).value || null,
            size: document.getElementById(`container_size_${i}`).value || null
          },
          stake: document.getElementById(`stake_${i}`).value || null,
          position: document.getElementById(`position_${i}`).value || null,
          soil: {
            moisture: document.getElementById(`soil_moisture_${i}`).value || null,
            ph: document.getElementById(`soil_ph_${i}`).value || null,
            fertility: document.getElementById(`soil_fertility_${i}`).value || null
          },
          growth: {
            current_stage: document.getElementById(`current_stage_${i}`).value || null,
            next_stage: document.getElementById(`next_stage_${i}`).value || null
          },
          observations: document.getElementById(`plant_observations_${i}`).value,
          actions: document.getElementById(`plant_actions_${i}`).value,
          notes: document.getElementById(`plant_notes_${i}`).value,
          qa: collectPlantQA(i),
          photos: photos
        };

        observations.push(obs);
      }

      return observations;
    }

    function collectPlantQA(plantObsId) {
      const qaPairs = [];
      const count = plantQACounts[plantObsId] || 0;

      for (let i = 1; i <= count; i++) {
        const questionEl = document.getElementById(`plant_question_${plantObsId}_${i}`);
        const answerEl = document.getElementById(`plant_answer_${plantObsId}_${i}`);
        if (questionEl && answerEl && questionEl.value) {
          qaPairs.push({
            question: questionEl.value,
            answer: answerEl.value
          });
        }
      }

      return qaPairs;
    }

    function closeModal() {
      document.getElementById('successModal').classList.remove('active');
      window.location.href = '/';
    }

    function addAnother() {
      document.getElementById('successModal').classList.remove('active');
      document.getElementById('dailyEntryForm').reset();
      document.getElementById('entry_date').valueAsDate = new Date();
      const localNow = new Date();
      const hours = localNow.getHours().toString().padStart(2, '0');
      const minutes = localNow.getMinutes().toString().padStart(2, '0');
      document.getElementById('entry_time').value = `${hours}:${minutes}`;

      // Clear all dynamic content
      qaCount = 0;
      actionCount = 0;
      plantObsCount = 0;
      document.getElementById('qaContainer').innerHTML = '';
      document.getElementById('actionsContainer').innerHTML = '';
      document.getElementById('plantObservationsContainer').innerHTML = '';
      Object.keys(plantPhotos).forEach(key => delete plantPhotos[key]);
    }
  </script>
</body>

</html>