<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Prep Tool â€“ Master Garden Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/static/mg.png">
</head>

<body>
  <!-- Sticky header matching dashboard style -->
  <header class="sticky-header">
    <div class="sticky-header-inner">
      <div class="header-title-row">
        <h1>ðŸ“¸ Photo Prep Tool</h1>
        <a href="/" class="nav-link">ðŸŒ¿ Back to Dashboard</a>
      </div>
      <p class="dashboard-subtitle">
        Prepare photos for your ChatGPT plant channels
      </p>
    </div>
  </header>

  <div class="page">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
      <div class="flash-message flash-{{ category }}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if not success %}
    <!-- Form Card -->
    <div class="card">
      <form method="POST" enctype="multipart/form-data" id="photoForm">
        <!-- File Upload Zone -->
        <div class="upload-zone" id="uploadZone">
          <div class="upload-icon">ðŸ“·</div>
          <div class="upload-text">Click to select photos or drag & drop</div>
          <div class="upload-subtext">Upload 1-20+ photos from your iPhone or Photos app</div>
          <input type="file" name="photos" id="fileInput" class="file-input" multiple
            accept="image/jpeg,image/jpg,image/png,image/heic">
        </div>

        <div id="selectedFiles" class="selected-files" style="display: none;">
          <strong>Selected files:</strong>
          <div class="form-hint" style="margin: 8px 0;">Check the box if a photo is a probe reading (it will be excluded
            from the photos list)</div>
          <div id="filesList" class="selected-files-list"></div>
        </div>

        <!-- Form Fields -->
        <div class="field-label">Plant ID *</div>
        <input type="text" id="plant_id" name="plant_id" class="form-input" required
          placeholder="e.g., basil_001, strawberry_002" list="plant-ids">
        <datalist id="plant-ids">
          {% for plant_id in available_plants %}
          <option value="{{ plant_id }}">
            {% endfor %}
        </datalist>
        <div class="form-hint">Select or type a plant ID from your garden</div>

        <div class="form-row">
          <div class="form-group">
            <div class="field-label">Date *</div>
            <input type="date" id="date" name="date" class="form-input" value="{{ current_date }}" required>
          </div>

          <div class="form-group">
            <div class="field-label">Starting Photo #</div>
            <input type="number" id="starting_number" name="starting_number" class="form-input" min="1"
              placeholder="Leave blank for 01">
            <div class="form-hint">Optional - defaults to 01</div>
          </div>
        </div>

        <div class="field-label">Context *</div>
        <select id="context" name="context" class="form-select" required>
          <option value="Initial">Initial</option>
          <option value="Follow-Up">Follow-Up</option>
        </select>
        <div class="form-hint">Initial = first check-in of the day, Follow-Up = additional same-day updates</div>

        <div style="margin-top: 16px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" name="include_watering" value="yes" checked>
            <span>Include watering assessment prompt (with current time)</span>
          </label>
        </div>

        <div class="field-label" style="margin-top: 16px;">Global Message (Weather)</div>
        <textarea id="global_message" name="global_message" class="form-textarea"
          placeholder="Today 12/11/2025: Mostly Sunny with a high of 73Â°F dropping to 53Â°F overnight..."></textarea>
        <div class="form-hint">Weather conditions - this will be saved for the next plant. Use {variable_name} for
          dynamic plant data (e.g., {id}, {garden_location}, {full_sun_start})</div>

        <div class="field-label">Plant-Specific Message</div>
        <textarea id="plant_message" name="plant_message" class="form-textarea"
          placeholder="Plant observations, questions, follow-ups..."></textarea>
        <div class="form-hint">Observations for this specific plant</div>

        <button type="submit" class="submit-btn">ðŸ“¤ Process Photos</button>
      </form>
    </div>
    {% endif %}

    {% if success %}
    <!-- Success Card -->
    <div class="card">
      <div class="output-header">
        <span class="success-icon">âœ…</span>
        <h2>Photos Processed Successfully!</h2>
      </div>

      <div class="output-info">
        <strong>{{ processed_count }}</strong> photo(s) compressed and saved to:<br>
        <code>{{ plant_folder }}</code>
      </div>

      <div class="field-label">Copy this message and paste it into ChatGPT:</div>

      <div class="output-code" id="outputCode">{{ output_message }}<button class="copy-btn"
          onclick="copyToClipboard()">Copy</button>
      </div>

      <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button onclick="processAnotherPlant()" class="submit-btn">ðŸŒ± Process Another Plant</button>
        <button onclick="startFresh()" class="submit-btn" style="background: var(--text-muted);">ðŸ”„ Start Fresh</button>
      </div>

      <script>
        // Save global message and date to localStorage
        const globalMessage = {{ (global_message if global_message else '')| tojson }};
        const currentDate = {{ (current_date if current_date else '')| tojson }};

        // Always save to localStorage (even if empty)
        localStorage.setItem('garden_global_message', globalMessage || '');

        function processAnotherPlant() {
          // Use the globalMessage variable from this success page
          const savedMessage = globalMessage || '';

          // Use currentDate from success page if available, otherwise try form input
          const dateToKeep = currentDate || '';

          let url = '/photo-prep?';
          if (savedMessage) {
            url += 'global_message=' + encodeURIComponent(savedMessage);
          }
          if (dateToKeep) {
            url += (savedMessage ? '&' : '') + 'date=' + encodeURIComponent(dateToKeep);
          }

          window.location.href = url;
        }

        function startFresh() {
          // Clear everything including global message
          localStorage.removeItem('garden_global_message');
          window.location.href = '/photo-prep';
        }
      </script>
    </div>
    {% endif %}
  </div>

  <script>
    // Pre-fill from URL parameters ONLY, or clear localStorage if no params
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const globalMsgFromUrl = urlParams.get('global_message');
      const dateFromUrl = urlParams.get('date');

      // If NO URL parameters, clear localStorage and show fresh form
      if (!globalMsgFromUrl && !dateFromUrl) {
        localStorage.removeItem('garden_global_message');
        return; // Leave form empty
      }

      // If URL parameters exist, use them and save to localStorage
      if (globalMsgFromUrl) {
        const globalMsg = globalMsgFromUrl; // URLSearchParams auto-decodes
        document.getElementById('global_message').value = globalMsg;
        localStorage.setItem('garden_global_message', globalMsg);
      }

      // Save global message to localStorage when typing
      const globalInput = document.getElementById('global_message');
      globalInput.addEventListener('input', function () {
        localStorage.setItem('garden_global_message', this.value);
      });
    });

    // Drag and drop functionality
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const selectedFiles = document.getElementById('selectedFiles');
    const filesList = document.getElementById('filesList');

    // Click to upload
    uploadZone.addEventListener('click', () => {
      fileInput.click();
    });

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone when dragging over
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.add('dragover');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.remove('dragover');
      }, false);
    });

    // Handle dropped files
    uploadZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const newFiles = dt.files;

      // Merge existing files with new files
      const dataTransfer = new DataTransfer();

      // Add existing files first
      if (fileInput.files) {
        Array.from(fileInput.files).forEach(file => {
          dataTransfer.items.add(file);
        });
      }

      // Add new files after
      Array.from(newFiles).forEach(file => {
        dataTransfer.items.add(file);
      });

      fileInput.files = dataTransfer.files;
      updateFileList(fileInput.files);
    }, false);

    // Handle selected files
    fileInput.addEventListener('change', (e) => {
      updateFileList(e.target.files);
    });

    function updateFileList(files) {
      if (files.length > 0) {
        selectedFiles.style.display = 'block';
        filesList.innerHTML = '';
        for (let i = 0; i < files.length; i++) {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';

          // Create thumbnail
          const thumbnail = document.createElement('img');
          thumbnail.className = 'file-thumbnail';
          thumbnail.alt = 'Preview';

          // Read file and create preview
          const reader = new FileReader();
          reader.onload = function (e) {
            thumbnail.src = e.target.result;
          };
          reader.readAsDataURL(files[i]);

          // Create checkbox
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `probe_${i}`;
          checkbox.name = `probe_reading_${i}`;
          checkbox.className = 'probe-checkbox';

          // Create label with filename
          const label = document.createElement('label');
          label.htmlFor = `probe_${i}`;
          label.className = 'file-label';
          label.textContent = `${i + 1}. ${files[i].name}`;

          // Probe reading indicator
          const probeLabel = document.createElement('span');
          probeLabel.textContent = '(probe reading)';
          probeLabel.className = 'probe-label';
          probeLabel.style.display = 'none';

          checkbox.addEventListener('change', () => {
            probeLabel.style.display = checkbox.checked ? 'inline' : 'none';
          });

          // Assemble the file item
          fileItem.appendChild(thumbnail);
          fileItem.appendChild(checkbox);
          fileItem.appendChild(label);
          fileItem.appendChild(probeLabel);
          filesList.appendChild(fileItem);
        }
      } else {
        selectedFiles.style.display = 'none';
      }
    }

    // Copy to clipboard function with working HTTP fallback
    function copyToClipboard() {
      const codeElement = document.getElementById('outputCode');
      const button = event.target;
      const text = codeElement.textContent.replace('Copy', '').trim();

      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showCopyFeedback(button);
        }).catch(() => {
          // Fallback for HTTP/mobile
          fallbackCopy(text, button);
        });
      } else {
        // Fallback for older browsers or HTTP
        fallbackCopy(text, button);
      }
    }

    function fallbackCopy(text, button) {
      // Create temporary textarea
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'absolute';
      textarea.style.left = '-9999px';
      textarea.setAttribute('readonly', '');
      document.body.appendChild(textarea);

      // Select and copy
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showCopyFeedback(button);
        } else {
          alert('Copy failed. Please manually select and copy the text.');
        }
      } catch (err) {
        alert('Copy not supported. Please manually select and copy the text.');
      }

      document.body.removeChild(textarea);
    }

    function showCopyFeedback(button) {
      const originalText = button.textContent;
      button.textContent = 'âœ“';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    }
  </script>

  <script>
    // Auto-populate photo number when context changes to Follow-Up
    document.getElementById('context').addEventListener('change', async function () {
      const context = this.value;
      const plantIdInput = document.getElementById('plant_id');
      const photoNumberInput = document.getElementById('starting_number');

      if (context === 'Follow-Up' && plantIdInput.value) {
        const plantId = plantIdInput.value.trim();

        try {
          const response = await fetch(`/api/plant/${plantId}/last-photo-number`);
          const data = await response.json();

          if (data.last_number !== undefined) {
            const nextNumber = data.last_number + 1;
            photoNumberInput.value = nextNumber;
            photoNumberInput.placeholder = `Next number: ${String(nextNumber).padStart(2, '0')}`;
          }
        } catch (error) {
          console.error('Error fetching last photo number:', error);
        }
      }
    });

    // Also trigger when plant_id changes (if context is already Follow-Up)
    document.getElementById('plant_id').addEventListener('change', async function () {
      const contextSelect = document.getElementById('context');
      if (contextSelect.value === 'Follow-Up') {
        contextSelect.dispatchEvent(new Event('change'));
      }
    });
  </script>
</body>

</html>