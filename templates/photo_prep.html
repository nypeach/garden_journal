<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Prep Tool ‚Äì Master Garden Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/static/mg.png">
</head>

<body>
  <!-- Sticky header matching dashboard style -->
  <header class="sticky-header">
    <div class="sticky-header-inner">
      <div class="header-title-row">
        <h1>üì∏ Photo Prep Tool</h1>
        <a href="/" class="nav-link">üåø Back to Dashboard</a>
      </div>
      <p class="dashboard-subtitle">
        Prepare photos for your ChatGPT plant channels
      </p>
    </div>
  </header>

  <div class="page">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
      <div class="flash-message flash-{{ category }}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if not success %}
    <!-- Form Card -->
    <div class="card">
      <form method="POST" enctype="multipart/form-data" id="photoForm">
        <!-- CONTEXT FIRST -->
        <div class="field-label">Context *</div>
        <select id="context" name="context" class="form-select" required>
          <option value="Initial" {% if context=='Initial' or not context %}selected{% endif %}>Initial</option>
          <option value="Follow-Up" {% if context=='Follow-Up' %}selected{% endif %}>Follow-Up</option>
        </select>
        <div class="form-hint">Initial = first check-in of the day, Follow-Up = additional same-day updates</div>

        <!-- DATE, PLANT ID, STARTING PHOTO #, TIME OVERRIDE - ALL ON SAME ROW -->
        <div class="form-row"
          style="display: grid; grid-template-columns: 1fr 1.5fr 1fr 1fr; gap: 12px; margin-top: 16px;">
          <div class="form-group">
            <div class="field-label">Date *</div>
            <input type="date" id="date" name="date" class="form-input" value="{{ current_date }}" required>
          </div>

          <div class="form-group">
            <div class="field-label">Plant ID *</div>
            <input type="text" id="plant_id" name="plant_id" class="form-input" required placeholder="e.g., basil_001"
              list="plant-ids" value="{{ plant_id if plant_id else '' }}">
            <datalist id="plant-ids">
              {% for plant_id in available_plants %}
              <option value="{{ plant_id }}">
                {% endfor %}
            </datalist>
          </div>

          <div class="form-group">
            <div class="field-label">Starting Photo #</div>
            <input type="number" id="starting_number" name="starting_number" class="form-input" min="1"
              placeholder="Leave blank for 01" value="{{ starting_number if starting_number else '' }}">
          </div>

          <div class="form-group">
            <div class="field-label">Time Override</div>
            <input type="text" id="time_override" name="time_override" class="form-input" placeholder="e.g., 8:09 AM"
              value="{{ time_override if time_override else '' }}">
          </div>
        </div>
        <div class="form-hint">Plant ID: Select from your garden ‚Ä¢ Photo #: Auto-fills for Follow-Up ‚Ä¢ Time: Overrides
          current time if provided</div>

        <!-- File Upload Zone -->
        <div class="upload-zone" id="uploadZone">
          <div class="upload-icon">üì∑</div>
          <div class="upload-text">Click to select photos or drag & drop</div>
          <div class="upload-subtext">Upload 1-20+ photos from your iPhone or Photos app</div>
          <input type="file" name="photos" id="fileInput" class="file-input" multiple
            accept="image/jpeg,image/jpg,image/png,image/heic">
        </div>

        <div id="selectedFiles" class="selected-files" style="display: none;">
          <strong>Selected files:</strong>
          <div class="form-hint" style="margin: 8px 0;">Check the box if a photo is a probe reading (it will be excluded
            from the photos list)</div>
          <div id="filesList" class="selected-files-list"></div>
        </div>


        <!-- CHECKBOXES -->
        <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 8px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <!-- <input type="checkbox" name="include_watering" value="yes" checked> -->
            <input type="checkbox" name="include_watering" value="yes">
            <span>Include watering assessment prompt (with current time)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="include_questions" name="include_questions" value="yes">
            <span>Include questions section (for Follow-Up with Q&A)</span>
          </label>
        </div>

        <!-- GLOBAL MESSAGE (WEATHER) -->
        <div id="global_message_container">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 16px;">
            <div class="field-label" style="margin: 0;">Global Message (Weather)</div>
            <button type="button" onclick="refreshWeather()" class="submit-btn"
              style="padding: 6px 12px; font-size: 0.85rem; background: var(--accent);">
              üå§Ô∏è Refresh Weather
            </button>
          </div>
          <textarea id="global_message" name="global_message" class="form-textarea"
            placeholder="Today 12/11/2025: Mostly Sunny with a high of 73¬∞F dropping to 53¬∞F overnight...">{{ global_message if global_message else '' }}</textarea>
          <div class="form-hint">Weather conditions - this will be saved for the next plant.
            Use {variable_name} for
            dynamic plant data (e.g., {id}, {garden_location}, {full_sun_start})</div>
        </div>

        <!-- PLANT-SPECIFIC MESSAGE -->
        <div class="field-label">Plant-Specific Message</div>
        <textarea id="plant_message" name="plant_message" class="form-textarea"
          placeholder="Plant observations, questions, follow-ups...">{{ plant_message if plant_message else '' }}</textarea>
        <div class="form-hint">Observations for this specific plant</div>

        <button type="submit" class="submit-btn">üì§ Process Photos</button>
      </form>
    </div>
    {% endif %}

    {% if success %}
    <!-- Success Card -->
    <div class="card">
      <div class="output-header">
        <span class="success-icon">‚úÖ</span>
        <h2>Photos Processed Successfully!</h2>
      </div>

      <div class="output-info">
        <strong>{{ processed_count }}</strong> photo(s) compressed and saved to:<br>
        <code>{{ plant_folder }}</code>
      </div>

      <div class="field-label">Copy this message and paste it into ChatGPT:</div>

      <div class="output-code" id="outputCode">{{ output_message }}<button class="copy-btn"
          onclick="copyToClipboard()">Copy</button>
      </div>

      <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button onclick="processAnotherPlant()" class="submit-btn">üå± Process Another Plant</button>
        <button onclick="startFresh()" class="submit-btn" style="background: var(--text-muted);">üîÑ Start Fresh</button>
      </div>

      <script>
        // Save global message and date to localStorage
        const globalMessage = {{ (global_message if global_message else '')| tojson }};
        const currentDate = {{ (current_date if current_date else '')| tojson }};

        // Always save to localStorage (even if empty)
        localStorage.setItem('garden_global_message', globalMessage || '');

        function processAnotherPlant() {
          // Use the globalMessage variable from this success page
          const savedMessage = globalMessage || '';

          // Use currentDate from success page if available, otherwise try form input
          const dateToKeep = currentDate || '';

          let url = '/photo-prep?';
          if (savedMessage) {
            url += 'global_message=' + encodeURIComponent(savedMessage);
          }
          if (dateToKeep) {
            url += (savedMessage ? '&' : '') + 'date=' + encodeURIComponent(dateToKeep);
          }

          window.location.href = url;
        }

        function startFresh() {
          // Clear everything including global message
          localStorage.removeItem('garden_global_message');
          // Keep weather cache - it will auto-fill on page load
          window.location.href = '/photo-prep';
        }
      </script>
    </div>
    {% endif %}
  </div>

  <script>
    // Drag and drop functionality
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const selectedFiles = document.getElementById('selectedFiles');
    const filesList = document.getElementById('filesList');

    // Click to upload
    uploadZone.addEventListener('click', () => {
      fileInput.click();
    });

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone when dragging over
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.add('dragover');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.remove('dragover');
      }, false);
    });

    // Handle dropped files
    uploadZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const newFiles = dt.files;

      // Merge existing files with new files
      const dataTransfer = new DataTransfer();

      // Add existing files first
      if (fileInput.files) {
        Array.from(fileInput.files).forEach(file => {
          dataTransfer.items.add(file);
        });
      }

      // Add new files after
      Array.from(newFiles).forEach(file => {
        dataTransfer.items.add(file);
      });

      fileInput.files = dataTransfer.files;
      updateFileList(fileInput.files);
    }, false);

    // Handle selected files
    fileInput.addEventListener('change', (e) => {
      updateFileList(e.target.files);
    });

    function updateFileList(files) {
      if (files.length > 0) {
        selectedFiles.style.display = 'block';
        filesList.innerHTML = '';
        for (let i = 0; i < files.length; i++) {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';

          // Create thumbnail
          const thumbnail = document.createElement('img');
          thumbnail.className = 'file-thumbnail';
          thumbnail.alt = 'Preview';

          // Read file and create preview
          const reader = new FileReader();
          reader.onload = function (e) {
            thumbnail.src = e.target.result;
          };
          reader.readAsDataURL(files[i]);

          // Create checkbox
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `probe_${i}`;
          checkbox.name = `probe_reading_${i}`;
          checkbox.className = 'probe-checkbox';

          // Create label with filename
          const label = document.createElement('label');
          label.htmlFor = `probe_${i}`;
          label.className = 'file-label';
          label.textContent = `${i + 1}. ${files[i].name}`;

          // Probe reading indicator
          const probeLabel = document.createElement('span');
          probeLabel.textContent = '(probe reading)';
          probeLabel.className = 'probe-label';
          probeLabel.style.display = 'none';

          checkbox.addEventListener('change', () => {
            probeLabel.style.display = checkbox.checked ? 'inline' : 'none';
          });

          // Assemble the file item
          fileItem.appendChild(thumbnail);
          fileItem.appendChild(checkbox);
          fileItem.appendChild(label);
          fileItem.appendChild(probeLabel);
          filesList.appendChild(fileItem);
        }
      } else {
        selectedFiles.style.display = 'none';
      }
    }

    // Copy to clipboard function with working HTTP fallback
    function copyToClipboard() {
      const codeElement = document.getElementById('outputCode');
      const button = event.target;
      const text = codeElement.textContent.replace('Copy', '').trim();

      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showCopyFeedback(button);
        }).catch(() => {
          // Fallback for HTTP/mobile
          fallbackCopy(text, button);
        });
      } else {
        // Fallback for older browsers or HTTP
        fallbackCopy(text, button);
      }
    }

    function fallbackCopy(text, button) {
      // Create temporary textarea
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'absolute';
      textarea.style.left = '-9999px';
      textarea.setAttribute('readonly', '');
      document.body.appendChild(textarea);

      // Select and copy
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showCopyFeedback(button);
        } else {
          alert('Copy failed. Please manually select and copy the text.');
        }
      } catch (err) {
        alert('Copy not supported. Please manually select and copy the text.');
      }

      document.body.removeChild(textarea);
    }

    function showCopyFeedback(button) {
      const originalText = button.textContent;
      button.textContent = '‚úì';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    }
  </script>

  <script>
    // Weather auto-fill functionality
    async function loadWeather(preserveOnError = false) {
      const globalMessageInput = document.getElementById('global_message');
      const today = new Date().toLocaleDateString('en-US');

      // If preserveOnError is true, keep existing value on error
      const currentValue = globalMessageInput.value;

      // ALWAYS try to fetch fresh weather first to validate cache is still reachable
      try {
        const response = await fetch('/api/weather/current');
        const data = await response.json();

        if (data.error) {
          if (preserveOnError) {
            // Keep current value if error occurred during form interaction
            globalMessageInput.value = currentValue;
          } else {
            // Show error message on initial load
            globalMessageInput.value = data.formatted_weather;  // "Weather unavailable - please add manually"
            // Clear stale cache
            localStorage.removeItem('garden_weather_cache');
          }
        } else {
          // Cache the weather data
          const cacheData = {
            date: today,
            tiles: data.tiles,
            detailed_forecasts: data.detailed_forecasts,
            formatted_weather: data.formatted_weather
          };
          localStorage.setItem('garden_weather_cache', JSON.stringify(cacheData));

          // Fill global message
          globalMessageInput.value = data.formatted_weather;
        }
      } catch (error) {
        console.error('Error fetching weather:', error);

        if (preserveOnError) {
          // Keep current value on error during form interaction
          globalMessageInput.value = currentValue;
        } else {
          // On fresh load, check if we have cached weather from today
          const cached = localStorage.getItem('garden_weather_cache');
          let usedCache = false;

          if (cached) {
            try {
              const weatherData = JSON.parse(cached);
              // Only use cache if it's from today AND we're offline (not a real error)
              if (weatherData.date === today) {
                globalMessageInput.value = weatherData.formatted_weather;
                usedCache = true;
              }
            } catch (e) {
              console.error('Error parsing cached weather:', e);
            }
          }

          // If no valid cache, show error message
          if (!usedCache) {
            globalMessageInput.value = 'Weather unavailable - please add manually';
            localStorage.removeItem('garden_weather_cache');
          }
        }
      }
    }

    // Manual refresh weather button handler
    function refreshWeather() {
      loadWeather(false);
    }

    // Show/hide global message based on context
    function updateGlobalMessageVisibility() {
      const context = document.getElementById('context').value;
      const container = document.getElementById('global_message_container');

      if (context === 'Follow-Up') {
        container.style.display = 'none';
      } else {
        container.style.display = 'block';
        // Don't auto-load weather - user can click Refresh Weather button if needed
      }
    }

    // AUTO-FETCH starting photo number when Plant ID changes in Follow-Up mode
    async function fetchStartingPhotoNumber() {
      const context = document.getElementById('context').value;
      const plantIdInput = document.getElementById('plant_id');
      const photoNumberInput = document.getElementById('starting_number');
      const dateInput = document.getElementById('date');

      if (context === 'Follow-Up' && plantIdInput.value) {
        const plantId = plantIdInput.value.trim();
        const dateValue = dateInput.value;

        try {
          const response = await fetch(`/api/plant/${plantId}/last-photo-number?date=${dateValue}`);
          const data = await response.json();

          if (data.error) {
            // Don't alert - just set placeholder
            photoNumberInput.value = '';
            photoNumberInput.placeholder = 'No journal entry';
          } else if (data.last_number !== undefined) {
            const nextNumber = data.last_number + 1;
            photoNumberInput.value = nextNumber;
            photoNumberInput.placeholder = `Next: ${String(nextNumber).padStart(2, '0')}`;
          }
        } catch (error) {
          console.error('Error fetching last photo number:', error);
          photoNumberInput.value = '';
          photoNumberInput.placeholder = 'Error checking';
        }
      }
    }

    // VALIDATION ON SUBMIT
    document.getElementById('photoForm').addEventListener('submit', async function (e) {
      const context = document.getElementById('context').value;

      if (context === 'Follow-Up') {
        const plantId = document.getElementById('plant_id').value.trim();
        const startingNumber = document.getElementById('starting_number').value.trim();
        const plantMessage = document.getElementById('plant_message').value.trim();
        const dateInput = document.getElementById('date').value;

        // VALIDATION CASE A: Plant ID exists but no starting photo
        if (plantId && (!startingNumber || startingNumber === '1')) {
          e.preventDefault();

          // Try to fetch it
          try {
            const response = await fetch(`/api/plant/${plantId}/last-photo-number?date=${dateInput}`);
            const data = await response.json();

            if (!data.error && data.last_number !== undefined) {
              const nextNumber = data.last_number + 1;
              document.getElementById('starting_number').value = nextNumber;
              // Resubmit the form
              this.submit();
              return;
            }
          } catch (error) {
            console.error('Error fetching photo number:', error);
          }
        }

        // VALIDATION CASE B: Plant-Specific Message is blank
        if (!plantMessage) {
          e.preventDefault();

          alert('Plant-Specific Message is required for Follow-Up');

          // Fetch starting photo if needed
          if (plantId && (!startingNumber || startingNumber === '1')) {
            await fetchStartingPhotoNumber();
          }

          // Put cursor in Plant-Specific Message
          document.getElementById('plant_message').focus();
          return;
        }
        // VALIDATION CASE C is handled server-side - removed to avoid duplicate alerts
      }
    });

    // SMART FIELD PERSISTENCE
    let savedPlantMessage = '';
    let savedPlantId = '';

    // Save plant message when typing
    document.getElementById('plant_message').addEventListener('input', function () {
      savedPlantMessage = this.value;
    });

    // Save plant ID when changing
    document.getElementById('plant_id').addEventListener('change', function () {
      savedPlantId = this.value;
    });

    // Restore plant message when date changes
    document.getElementById('date').addEventListener('change', function () {
      if (savedPlantMessage) {
        document.getElementById('plant_message').value = savedPlantMessage;
      }
      if (savedPlantId) {
        document.getElementById('plant_id').value = savedPlantId;
      }

      // Refetch starting photo number if in Follow-Up mode
      fetchStartingPhotoNumber();
    });

    // Restore plant message when plant ID changes
    document.getElementById('plant_id').addEventListener('change', function () {
      if (savedPlantMessage) {
        document.getElementById('plant_message').value = savedPlantMessage;
      }

      // Auto-fetch starting photo in Follow-Up mode
      fetchStartingPhotoNumber();
    });

    // SINGLE DOMContentLoaded handler - combines all initialization logic
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const globalMsgFromUrl = urlParams.get('global_message');
      const dateFromUrl = urlParams.get('date');
      const globalMessageInput = document.getElementById('global_message');
      const plantIdInput = document.getElementById('plant_id');
      const plantMessageInput = document.getElementById('plant_message');

      // Initialize saved values
      savedPlantMessage = plantMessageInput.value;
      savedPlantId = plantIdInput.value;

      // Check if any form field has a value (indicates error re-render from server)
      const hasExistingValue = globalMessageInput.value.trim() !== '' ||
        plantIdInput.value.trim() !== '' ||
        plantMessageInput.value.trim() !== '';

      // Handle URL parameter pre-fill (for Process Another Plant)
      if (globalMsgFromUrl) {
        const globalMsg = globalMsgFromUrl;
        globalMessageInput.value = globalMsg;
        localStorage.setItem('garden_global_message', globalMsg);

        // Show/hide container based on context
        const context = document.getElementById('context').value;
        const container = document.getElementById('global_message_container');
        if (context === 'Follow-Up') {
          container.style.display = 'none';
        } else {
          container.style.display = 'block';
        }
      } else if (hasExistingValue) {
        // Error re-render - keep ALL existing values from server, don't load weather
        const context = document.getElementById('context').value;
        const container = document.getElementById('global_message_container');

        if (context === 'Follow-Up') {
          container.style.display = 'none';
        } else {
          container.style.display = 'block';
          // Keep existing value, don't overwrite with fresh weather
        }

        // Don't clear localStorage - preserve everything
      } else if (!dateFromUrl) {
        // Fresh load (no URL params) - clear localStorage and load weather
        localStorage.removeItem('garden_global_message');
        updateGlobalMessageVisibility();
        // Auto-load weather on fresh page load only
        loadWeather();
      } else {
        // Has date param but no global message - show/hide but don't load weather
        updateGlobalMessageVisibility();
      }

      // Save global message to localStorage when typing
      const globalInput = document.getElementById('global_message');
      globalInput.addEventListener('input', function () {
        localStorage.setItem('garden_global_message', this.value);
      });

      // Auto-fetch starting photo on page load if in Follow-Up mode
      fetchStartingPhotoNumber();
    });

    // Auto-populate photo number when context changes to Follow-Up
    document.getElementById('context').addEventListener('change', async function () {
      const context = this.value;
      const photoNumberInput = document.getElementById('starting_number');

      // Clear starting photo number when switching to Initial
      if (context === 'Initial') {
        photoNumberInput.value = '';
        photoNumberInput.placeholder = 'Leave blank for 01';
      }

      // Handle Follow-Up photo number auto-population
      if (context === 'Follow-Up') {
        await fetchStartingPhotoNumber();
      }

      // Update global message visibility (don't auto-load weather)
      updateGlobalMessageVisibility();
    });
  </script>

</body>

</html>