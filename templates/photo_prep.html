<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Photo Prep Tool ‚Äì Master Garden Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <!-- Sticky header matching dashboard style -->
  <header class="sticky-header">
    <div class="sticky-header-inner">
      <h1>üì∏ Photo Prep Tool</h1>
      <p class="dashboard-subtitle">
        Prepare photos for your ChatGPT plant channels
      </p>
      <div class="chip-row">
        <a href="/" class="nav-link">‚Üê Back to Dashboard</a>
      </div>
    </div>
  </header>

  <div class="page">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
      <div class="flash-message flash-{{ category }}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if not success %}
    <!-- Form Card -->
    <div class="card">
      <form method="POST" enctype="multipart/form-data" id="photoForm">
        <!-- File Upload Zone -->
        <div class="upload-zone" id="uploadZone">
          <div class="upload-icon">üì∑</div>
          <div class="upload-text">Click to select photos or drag & drop</div>
          <div class="upload-subtext">Upload 1-20+ photos from your iPhone or Photos app</div>
          <input type="file" name="photos" id="fileInput" class="file-input" multiple
            accept="image/jpeg,image/jpg,image/png,image/heic">
        </div>

        <div id="selectedFiles" class="selected-files" style="display: none;">
          <strong>Selected files:</strong>
          <ul id="filesList" class="selected-files-list"></ul>
        </div>

        <!-- Form Fields -->
        <div class="field-label">Plant ID *</div>
        <input type="text" id="plant_id" name="plant_id" class="form-input" required
          placeholder="e.g., basil_001, strawberry_002" list="plant-ids">
        <datalist id="plant-ids">
          {% for plant_id in available_plants %}
          <option value="{{ plant_id }}">
            {% endfor %}
        </datalist>
        <div class="form-hint">Select or type a plant ID from your garden</div>

        <div class="field-label">Channel Type *</div>
        <div class="form-row">
          <label class="radio-label">
            <input type="radio" name="channel_type" value="existing" checked>
            <span>Existing Channel (has journal history)</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="channel_type" value="new">
            <span>New Channel (first entry ever)</span>
          </label>
        </div>
        <div class="form-hint">Select "Existing" if this plant already has journal entries, "New" if this is the first
          entry</div>

        <div class="form-row">
          <div class="form-group">
            <div class="field-label">Date *</div>
            <input type="date" id="date" name="date" class="form-input" value="{{ current_date }}" required>
          </div>

          <div class="form-group">
            <div class="field-label">Starting Photo #</div>
            <input type="number" id="starting_number" name="starting_number" class="form-input" min="1"
              placeholder="Leave blank for 01">
            <div class="form-hint">Optional - defaults to 01</div>
          </div>
        </div>

        <div class="field-label">Context *</div>
        <select id="context" name="context" class="form-select" required>
          <option value="Initial">Initial</option>
          <option value="Follow-Up">Follow-Up</option>
        </select>

        <div class="field-label">Global Message (Weather)</div>
        <textarea id="global_message" name="global_message" class="form-textarea"
          placeholder="Today 12/11/2025: Mostly Sunny with a high of 73¬∞F dropping to 53¬∞F overnight..."></textarea>
        <div class="form-hint">Weather conditions - this will be saved for the next plant</div>

        <div class="field-label">Plant-Specific Message</div>
        <textarea id="plant_message" name="plant_message" class="form-textarea"
          placeholder="Plant observations, questions, follow-ups..."></textarea>
        <div class="form-hint">Observations for this specific plant</div>

        <button type="submit" class="submit-btn">üì§ Process Photos</button>
      </form>
    </div>
    {% endif %}

    {% if success %}
    <!-- Success Card -->
    <div class="card">
      <div class="output-header">
        <span class="success-icon">‚úÖ</span>
        <h2>Photos Processed Successfully!</h2>
      </div>

      <div class="output-info">
        <strong>{{ processed_count }}</strong> photo(s) compressed and saved to:<br>
        <code>{{ plant_folder }}</code>
      </div>

      <div class="field-label">Copy this message and paste it into ChatGPT:</div>

      <div class="output-code" id="outputCode">{{ output_message }}<button class="copy-btn"
          onclick="copyToClipboard()">Copy</button>
      </div>

      <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button onclick="processAnotherPlant()" class="submit-btn">üå± Process Another Plant</button>
        <button onclick="startFresh()" class="submit-btn" style="background: var(--text-muted);">üîÑ Start Fresh</button>
      </div>

      <script>
        // Save global message to localStorage
        const globalMessage = `{{ global_message if global_message else '' }}`;
        if (globalMessage) {
          localStorage.setItem('garden_global_message', globalMessage);
        }

        function processAnotherPlant() {
          // Keep global message, clear everything else
          const saved = localStorage.getItem('garden_global_message') || '';
          window.location.href = '/photo-prep?global_message=' + encodeURIComponent(saved);
        }

        function startFresh() {
          // Clear everything including global message
          localStorage.removeItem('garden_global_message');
          window.location.href = '/photo-prep';
        }
      </script>
    </div>
    {% endif %}
  </div>

  <script>
    // Pre-fill global message from localStorage or URL parameter
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const globalMsg = urlParams.get('global_message') || localStorage.getItem('garden_global_message') || '';

      if (globalMsg) {
        document.getElementById('global_message').value = globalMsg;
      }

      // Save global message to localStorage when typing
      const globalInput = document.getElementById('global_message');
      globalInput.addEventListener('input', function () {
        localStorage.setItem('garden_global_message', this.value);
      });
    });

    // Drag and drop functionality
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const selectedFiles = document.getElementById('selectedFiles');
    const filesList = document.getElementById('filesList');

    // Click to upload
    uploadZone.addEventListener('click', () => {
      fileInput.click();
    });

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop zone when dragging over
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.add('dragover');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.remove('dragover');
      }, false);
    });

    // Handle dropped files
    uploadZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      updateFileList(files);
    }, false);

    // Handle selected files
    fileInput.addEventListener('change', (e) => {
      updateFileList(e.target.files);
    });

    function updateFileList(files) {
      if (files.length > 0) {
        selectedFiles.style.display = 'block';
        filesList.innerHTML = '';
        for (let i = 0; i < files.length; i++) {
          const li = document.createElement('li');
          li.textContent = `${i + 1}. ${files[i].name}`;
          filesList.appendChild(li);
        }
      } else {
        selectedFiles.style.display = 'none';
      }
    }

    // Copy to clipboard function
    function copyToClipboard() {
      const codeElement = document.getElementById('outputCode');
      const text = codeElement.textContent.replace('Copy', '').trim();

      navigator.clipboard.writeText(text).then(() => {
        const btn = codeElement.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = 'Copy';
        }, 2000);
      });
    }
  </script>
</body>

</html>