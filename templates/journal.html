<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>{{ plant_emoji }} {{ plant_name }} â€“ Journal</title>
  <link rel="stylesheet" href="/static/style.css">
</head>

<body>
  <!-- Sticky header for the Journal -->
  <header class="sticky-header" id="top-nav">
    <div class="sticky-header-inner">
      <div class="journal-header">
        <div class="journal-header-top">
          <h1>{{ plant_emoji }} {{ plant_name }} Journal</h1>
          <span class="pill"><span class="pill-dot"></span> {{ current_stage }}</span>
        </div>
        <div class="journal-current-state">{{ current_state }}</div>
      </div>
    </div>
  </header>

  <div class="page">
    <!-- DAILY ENTRIES (NEWEST â†’ OLDEST) -->
    {% for entry in journal %}
    <section class="journal-entry" id="entry-{{ entry.date.replace('/', '-') }}">
      <h2>{{ entry.date }}</h2>
      <div class="card">
        <div class="plant-header">
          <div>
            <div class="plant-name">{{ plant_name }}</div>
            <div class="journal-meta">
              <span><strong>{{ entry.time }}</strong></span>
              <span>Conditions: {{ entry.conditions }}</span>
            </div>
          </div>
        </div>

        <!-- Digital Probe (only show if any values exist) -->
        {% if entry.digital_probe.ph or entry.digital_probe.ec_mScm or entry.digital_probe.moisture_mScm or
        entry.digital_probe.fertility_percent %}
        <div class="field-label">Digital Probe</div>
        <ul class="probe-grid">
          {% if entry.digital_probe.ph %}<li><strong>pH:</strong> {{ entry.digital_probe.ph }}</li>{% endif %}
          {% if entry.digital_probe.ec_mScm %}<li><strong>EC:</strong> {{ entry.digital_probe.ec_mScm }} mS/cm</li>{%
          endif %}
          {% if entry.digital_probe.salt_mg_L %}<li><strong>Salt:</strong> {{ entry.digital_probe.salt_mg_L }} mg/L</li>
          {% endif %}
          {% if entry.digital_probe.moisture_mScm %}<li><strong>Moisture:</strong> {{ entry.digital_probe.moisture_mScm
            }} mS/cm</li>{% endif %}
          {% if entry.digital_probe.light %}<li><strong>Light:</strong> {{ entry.digital_probe.light }}</li>{% endif %}
          {% if entry.digital_probe.rh_percent %}<li><strong>RH:</strong> {{ entry.digital_probe.rh_percent }}%</li>{%
          endif %}
          {% if entry.digital_probe.fertility_percent %}<li><strong>Fertility:</strong> {{
            entry.digital_probe.fertility_percent }}%</li>{% endif %}
          {% if entry.digital_probe.soil_temp_f %}<li><strong>Soil Temp:</strong> {{ entry.digital_probe.soil_temp_f
            }}Â°F</li>{% endif %}
        </ul>
        {% endif %}

        <!-- Analog Probe (only show if any values exist) -->
        {% if entry.analog_probe.fertility or entry.analog_probe.moisture or entry.analog_probe.ph %}
        <div class="field-label">Analog Probe</div>
        <ul class="probe-grid">
          {% if entry.analog_probe.fertility %}<li><strong>Fertility:</strong> {{ entry.analog_probe.fertility }}</li>{%
          endif %}
          {% if entry.analog_probe.moisture %}<li><strong>Moisture:</strong> {{ entry.analog_probe.moisture }}</li>{%
          endif %}
          {% if entry.analog_probe.ph %}<li><strong>pH:</strong> {{ entry.analog_probe.ph }}</li>{% endif %}
        </ul>
        {% endif %}

        <!-- Observations -->
        {% if entry.observations %}
        <div class="field-label">Observations</div>
        <p>{{ entry.observations }}</p>
        {% endif %}

        <!-- Actions -->
        {% if entry.actions %}
        <div class="field-label">Actions</div>
        <p>{{ entry.actions }}</p>
        {% endif %}

        <!-- Next Steps -->
        {% if entry.next_steps %}
        <div class="field-label">Next Steps</div>
        <p>{{ entry.next_steps }}</p>
        {% endif %}

        <!-- Q&A Summary -->
        {% if entry.q_and_a_summary %}
        <div class="field-label">Q&A Summary</div>
        <p>{{ entry.q_and_a_summary }}</p>
        {% endif %}

        <!-- Follow-Up Log -->
        {% if entry.follow_up %}
        <div class="field-label">Follow-Up Log</div>
        <ul>
          {% for followup in entry.follow_up %}
          <li>{{ followup }}</li>
          {% endfor %}
        </ul>
        {% endif %}

        <!-- Photos -->
        {% if entry.photos %}
        <div class="field-label">Photos</div>
        <div class="photo-grid">
          {% for photo in entry.photos %}
          <figure class="photo-item">
            {% if photo.file_name == "<<put filename here>>" %}
              <div class="photo-placeholder placeholder-upload" data-plant-id="{{ plant_id }}"
                data-date="{{ entry.date }}" data-photo-index="{{ loop.index }}">
                ðŸ“· Click or Drop Photo Here
                <input type="file" class="placeholder-file-input" accept="image/jpeg,image/jpg,image/png,image/heic"
                  style="display: none;">
              </div>
              {% else %}
              <img src="/photos/{{ plant_id }}/{{ photo.file_name }}" alt="{{ photo.caption }}">
              {% endif %}
              <figcaption class="photo-caption">{{ photo.caption }}</figcaption>
          </figure>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </section>
    {% endfor %}
  </div>

  <script>
    // Placeholder photo upload functionality
    document.addEventListener('DOMContentLoaded', function () {
      const placeholders = document.querySelectorAll('.placeholder-upload');

      placeholders.forEach(function (placeholder) {
        const fileInput = placeholder.querySelector('.placeholder-file-input');

        // Click placeholder to open file picker
        placeholder.addEventListener('click', function (e) {
          // Don't trigger if dropping
          if (!placeholder.classList.contains('dropping')) {
            fileInput.click();
          }
        });

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          placeholder.addEventListener(eventName, function (e) {
            e.preventDefault();
            e.stopPropagation();
          }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
          placeholder.addEventListener(eventName, function () {
            placeholder.classList.add('dropping');
            placeholder.style.borderColor = 'var(--accent)';
            placeholder.style.background = 'var(--accent-soft)';
          }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          placeholder.addEventListener(eventName, function () {
            placeholder.classList.remove('dropping');
            placeholder.style.borderColor = '';
            placeholder.style.background = '';
          }, false);
        });

        // Handle dropped files
        placeholder.addEventListener('drop', function (e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length > 0) {
            // Create a new FileList-like object
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]); // Only take first file
            fileInput.files = dataTransfer.files;

            // Trigger the change event
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
          }
        }, false);

        // Handle file selection (both click and drop)
        fileInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const plantId = placeholder.getAttribute('data-plant-id');
          const date = placeholder.getAttribute('data-date');
          const photoIndex = placeholder.getAttribute('data-photo-index');

          // Show loading state
          placeholder.innerHTML = 'â³ Uploading...';
          placeholder.style.cursor = 'wait';

          // Create form data
          const formData = new FormData();
          formData.append('photo', file);
          formData.append('plant_id', plantId);
          formData.append('date', date);
          formData.append('photo_index', photoIndex);

          // Upload photo
          fetch('/upload-placeholder-photo', {
            method: 'POST',
            body: formData
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Replace placeholder with actual image
                const img = document.createElement('img');
                img.src = data.photo_url;
                img.alt = 'Uploaded photo';
                placeholder.parentElement.querySelector('.photo-placeholder').replaceWith(img);
              } else {
                alert('Error uploading photo: ' + (data.error || 'Unknown error'));
                placeholder.innerHTML = 'ðŸ“· Click or Drop Photo Here';
                placeholder.style.cursor = 'pointer';
              }
            })
            .catch(error => {
              console.error('Upload error:', error);
              alert('Error uploading photo: ' + error);
              placeholder.innerHTML = 'ðŸ“· Click or Drop Photo Here';
              placeholder.style.cursor = 'pointer';
            });
        });
      });
    });
  </script>
</body>

</html>